<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Syslog Analysis - Network Engineer's Interactive Toolbox</title>
    <link rel="stylesheet" href="css/styles.css">
    <script src="js/common.js"></script>
    <script src="js/script.js"></script>
    <script src="js/bug-report.js"></script>
    <style>
        /* Syslog Analysis specific styles */
        .syslog-container {
            display: flex;
            flex-direction: column;
            gap: 20px;
            width: 100%;
        }
        
        .input-section {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .input-options {
            display: flex;
            gap: 20px;
            margin-bottom: 10px;
        }
        
        .input-option {
            padding: 10px;
            background-color: var(--card-bg);
            border-radius: 5px;
            cursor: pointer;
            border: 2px solid transparent;
        }
        
        .input-option.active {
            border-color: var(--accent-color);
        }
        
        .file-input-container, .text-input-container {
            padding: 15px;
            background-color: var(--card-bg);
            border-radius: 5px;
            margin-bottom: 15px;
        }
        
        .controls {
            display: flex;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .grouping-options, .search-container, .export-options {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .logs-container {
            margin-top: 20px;
        }
        
        .log-group {
            margin-bottom: 15px;
            border: 1px solid var(--border-color);
            border-radius: 5px;
            overflow: hidden;
        }
        
        .log-group-header {
            display: flex;
            justify-content: space-between;
            padding: 10px 15px;
            background-color: var(--card-bg);
            cursor: pointer;
        }
        
        .log-group-content {
            display: none;
            padding: 0;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .log-group.expanded .log-group-content {
            display: block;
        }
        
        .log-entry {
            display: grid;
            grid-template-columns: 180px 150px 120px 1fr;
            padding: 8px 15px;
            border-bottom: 1px solid var(--border-color);
        }
        
        .log-entry:last-child {
            border-bottom: none;
        }
        
        .log-entry:nth-child(even) {
            background-color: var(--alt-row-bg);
        }
        
        .timestamp {
            font-family: monospace;
        }
        
        .message {
            word-break: break-word;
        }
        
        .highlight {
            background-color: yellow;
            color: black;
        }
        
        .no-results {
            padding: 20px;
            text-align: center;
            background-color: var(--card-bg);
            border-radius: 5px;
        }
        
        #syslog-text {
            width: 100%;
            min-height: 200px;
            font-family: monospace;
            padding: 10px;
            border-radius: 5px;
            border: 1px solid var(--border-color);
            background-color: var(--input-bg);
            color: var(--text-color);
        }
        
        /* Footer buttons */
        .footer-buttons {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background-color: var(--bg-color);
            padding: 10px;
            display: flex;
            justify-content: center;
            gap: 20px;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
            z-index: 100;
        }
        
        .footer-buttons button {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            background-color: var(--secondary-color);
            color: white;
            cursor: pointer;
            font-weight: bold;
        }
        
        .footer-buttons button:hover {
            background-color: var(--hover-color);
        }
        
        /* Add padding to main to prevent content from being hidden behind footer buttons */
        main {
            padding-bottom: 60px;
        }
    </style>
<script src="https://sites.super.myninja.ai/_assets/ninja-daytona-script.js"></script>
</head>
<body>
    <header>
        <div>
            <h1>Network Engineers Interactive Toolbox</h1>
            <p>A comprehensive suite of tools for senior network engineers</p>
        </div>
        <div class="header-right">
            <div id="theme-toggle" class="theme-toggle" title="Toggle dark/light mode">ðŸŒ™</div>
            <div class="version-indicator">v2.6</div>
        </div>
    </header>
    
    <nav>
        <ul>
            <li>
                <a href="index.html">Home</a>
            </li>
            <li>
                <a href="troubleshooting.html">Troubleshooting Tools</a>
            </li>
            <li>
                <a href="junos-convertor.html">Configuration Convertor</a>
            </li>
            <li>
                <a href="subnet-calculator.html">IP Subnet Calculator</a>
            </li>
            <li>
                <a href="password-decrypt.html">Password Decrypt</a>
            </li>
            <li>
                <a href="whois-lookup.html">WHOIS Lookup</a>
            </li>
            <li>
                <a href="bgp-tools.html">BGP Lookup Tools</a>
            </li>
            <li>
                <a href="syslog-analysis.html">Syslog Analysis</a>
            </li>
            <li>
                <a href="engineer-tools.html">Engineer Tools</a>
            </li>
            <li>
                <a href="quick-links.html">Quick Links</a>
                <div class="tooltip">Useful bookmarks</div>
            </li>
            <li>
                <a href="help.html">Help</a>
            </li>
            <li>
                <a href="qa.html">Q&A</a>
            </li>
        </ul>
    </nav>
    
    <main>
        <div class="tool-container">
            <h2>Syslog Analysis</h2>
            <p>Analyze and visualize syslog data from network devices. Upload a CSV file or paste CSV data directly.</p>
            
            <div class="syslog-container">
                <div class="input-section">
                    <div class="input-options">
                        <div id="file-option" class="input-option active" onclick="switchInputMethod('file')">Upload CSV File</div>
                        <div id="text-option" class="input-option" onclick="switchInputMethod('text')">Paste CSV Data</div>
                    </div>
                    
                    <div id="file-input" class="file-input-container">
                        <input type="file" id="syslog-file" accept=".csv">
                        <button class="btn" onclick="handleFileUpload(event)">Upload File</button>
                    </div>
                    
                    <div id="text-input" class="text-input-container" style="display: none;">
                        <label for="syslog-text">Paste CSV data below (may take 10 secs):</label>
                        <textarea id="syslog-text" placeholder="Paste CSV data here..."></textarea>
                        <button class="btn" onclick="parseTextInput()">Parse Data</button>
                    </div>
                </div>
                
                <div class="controls" id="controls" style="display: none;">
                    <div class="grouping-options">
                        <label for="grouping">Group by:</label>
                        <select id="grouping" onchange="regroupLogs()">
                            <option value="host.name">Hostname</option>
                            <option value="event.category">Event Category</option>
                        </select>
                    </div>
                    
                    <div class="search-container">
                        <input type="text" id="search-input" placeholder="Search logs..." oninput="filterLogs()">
                        <button class="btn" onclick="clearSearch()">Clear</button>
                    </div>
                    
                    <div class="export-options">
                        <button class="btn" onclick="exportToCSV()">Export CSV</button>
                        <button class="btn" onclick="exportToJSON()">Export JSON</button>
                    </div>
                </div>
                
                <div class="logs-container" id="logs-container"></div>
            </div>
        </div>
    </main>
    
    <div class="footer-buttons">
        <button onclick="runDiagnostics()">Run Self-Diagnostics</button>
        <button onclick="reportBug()">Report a Bug</button>
    </div>
    
    <footer>
        <p>&copy; Iain Murdoch 2025 | v2.6</p>
    </footer>
    
    <!-- Diagnostics Panel -->
    <div id="diagnosticsPanel" style="display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 80%; max-width: 600px; background: var(--card-bg); padding: 20px; border-radius: 8px; box-shadow: 0 0 20px rgba(0,0,0,0.3); z-index: 1000;">
        <h3>Self-Diagnostics Results</h3>
        <pre id="diagnosticsResults" style="background: var(--code-bg); padding: 15px; border-radius: 5px; max-height: 300px; overflow-y: auto;"></pre>
        <button onclick="document.getElementById('diagnosticsPanel').style.display = 'none';" style="padding: 8px 15px; background: var(--secondary-color); color: white; border: none; border-radius: 4px; cursor: pointer; margin-top: 10px;">Close</button>
    </div>
    
    <script>
        // Global variables
        let syslogData = [];
        let filteredData = [];
        let currentGrouping = 'host.name';
        let searchTerm = '';
        
        // Input method switching
        function switchInputMethod(method) {
            document.getElementById('file-option').classList.toggle('active', method === 'file');
            document.getElementById('text-option').classList.toggle('active', method === 'text');
            document.getElementById('file-input').style.display = method === 'file' ? 'block' : 'none';
            document.getElementById('text-input').style.display = method === 'text' ? 'block' : 'none';
        }
        
        // File upload handler
        function handleFileUpload(event) {
            const fileInput = document.getElementById('syslog-file');
            const file = fileInput.files[0];
            
            if (!file) {
                alert('Please select a CSV file first.');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const csvData = e.target.result;
                parseCSV(csvData);
            };
            reader.readAsText(file);
        }
        
        // Parse text input
        function parseTextInput() {
            const csvData = document.getElementById('syslog-text').value;
            if (!csvData.trim()) {
                alert('Please paste CSV data first.');
                return;
            }
            parseCSV(csvData);
        }
        
        // CSV parsing function
        function parseCSV(csvText) {
            try {
                // Split by lines and handle quoted fields
                const lines = csvText.split('\n');
                if (lines.length < 2) {
                    throw new Error('CSV data must contain at least a header row and one data row');
                }
                
                // Parse header
                const headers = parseCSVLine(lines[0]);
                
                // Parse data rows
                syslogData = [];
                for (let i = 1; i < lines.length; i++) {
                    if (!lines[i].trim()) continue;
                    
                    const values = parseCSVLine(lines[i]);
                    if (values.length !== headers.length) {
                        console.warn(`Skipping row ${i+1} due to column count mismatch`);
                        continue;
                    }
                    
                    const entry = {};
                    headers.forEach((header, index) => {
                        entry[header] = values[index];
                    });
                    
                    syslogData.push(entry);
                }
                
                // Show controls and display logs
                document.getElementById('controls').style.display = 'flex';
                filteredData = [...syslogData];
                displayLogs();
                
                // Show success message
                alert(`CSV data successfully parsed. ${syslogData.length} log entries loaded.`);
                
            } catch (error) {
                alert(`Error parsing CSV: ${error.message}`);
                console.error('CSV parsing error:', error);
            }
        }
        
        // Parse a single CSV line handling quoted fields
        function parseCSVLine(line) {
            const result = [];
            let inQuotes = false;
            let currentValue = '';
            
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                
                if (char === '"') {
                    if (inQuotes && i + 1 < line.length && line[i + 1] === '"') {
                        // Double quotes inside quotes - add a single quote
                        currentValue += '"';
                        i++;
                    } else {
                        // Toggle quote mode
                        inQuotes = !inQuotes;
                    }
                } else if (char === ',' && !inQuotes) {
                    // End of field
                    result.push(currentValue);
                    currentValue = '';
                } else {
                    // Normal character
                    currentValue += char;
                }
            }
            
            // Add the last field
            result.push(currentValue);
            return result;
        }
        
        // Group logs by the selected field
        function groupLogs(data, groupField) {
            const groups = {};
            
            data.forEach(entry => {
                const groupValue = entry[groupField] || 'Unknown';
                if (!groups[groupValue]) {
                    groups[groupValue] = [];
                }
                groups[groupValue].push(entry);
            });
            
            return groups;
        }
        
        // Sort logs by timestamp
        function sortLogsByTimestamp(logs) {
            return logs.sort((a, b) => {
                const timestampA = a['@timestamp'] || '';
                const timestampB = b['@timestamp'] || '';
                return timestampA.localeCompare(timestampB);
            });
        }
        
        // Highlight search term in text
        function highlightSearchTerm(text) {
            if (!searchTerm) return text;
            
            const regex = new RegExp(searchTerm, 'gi');
            return text.replace(regex, match => `<span class="highlight">${match}</span>`);
        }
        
        // Display logs in the UI
        function displayLogs() {
            const container = document.getElementById('logs-container');
            container.innerHTML = '';
            
            if (filteredData.length === 0) {
                container.innerHTML = '<div class="no-results">No logs found matching your criteria.</div>';
                return;
            }
            
            // Group logs
            const groups = groupLogs(filteredData, currentGrouping);
            
            // Create log groups
            Object.keys(groups).sort().forEach(groupName => {
                const groupLogs = sortLogsByTimestamp(groups[groupName]);
                const groupCount = groupLogs.length;
                
                const groupElement = document.createElement('div');
                groupElement.className = 'log-group';
                
                // Create group header
                const headerElement = document.createElement('div');
                headerElement.className = 'log-group-header';
                headerElement.innerHTML = `
                    <span>${groupName}</span>
                    <span>${groupCount} log${groupCount !== 1 ? 's' : ''}</span>
                `;
                headerElement.onclick = () => toggleGroup(groupElement);
                
                // Create group content
                const contentElement = document.createElement('div');
                contentElement.className = 'log-group-content';
                
                // Add log entries
                groupLogs.forEach(log => {
                    const logElement = document.createElement('div');
                    logElement.className = 'log-entry';
                    
                    // Format timestamp
                    const timestamp = log['@timestamp'] || 'N/A';
                    
                    // Create log entry content
                    // Change "authentication" to "Output" in the display
                    const eventCategory = log['event.category'] === 'authentication' ? 'Output' : (log['event.category'] || 'N/A');
                    
                    logElement.innerHTML = `
                        <div class="timestamp">${timestamp}</div>
                        <div class="hostname">${log['host.name'] || 'N/A'}</div>
                        <div class="event-category">${eventCategory}</div>
                        <div class="message">${highlightSearchTerm(log.message || 'N/A')}</div>
                    `;
                    
                    contentElement.appendChild(logElement);
                });
                
                groupElement.appendChild(headerElement);
                groupElement.appendChild(contentElement);
                container.appendChild(groupElement);
            });
        }
        
        // Toggle log group expansion
        function toggleGroup(groupElement) {
            groupElement.classList.toggle('expanded');
        }
        
        // Regroup logs based on selected grouping field
        function regroupLogs() {
            currentGrouping = document.getElementById('grouping').value;
            displayLogs();
        }
        
        // Filter logs based on search term
        function filterLogs() {
            searchTerm = document.getElementById('search-input').value.toLowerCase();
            
            if (!searchTerm) {
                filteredData = [...syslogData];
            } else {
                filteredData = syslogData.filter(log => {
                    return (
                        (log.message && log.message.toLowerCase().includes(searchTerm)) ||
                        (log['host.name'] && log['host.name'].toLowerCase().includes(searchTerm)) ||
                        (log['@timestamp'] && log['@timestamp'].toLowerCase().includes(searchTerm)) ||
                        (log['event.category'] && log['event.category'].toLowerCase().includes(searchTerm))
                    );
                });
            }
            
            displayLogs();
        }
        
        // Clear search and reset data
        function clearSearch() {
            document.getElementById('search-input').value = '';
            searchTerm = '';
            filteredData = [...syslogData];
            displayLogs();
            
            // Also clear the textarea if we're in text input mode
            if (document.getElementById('text-input').style.display !== 'none') {
                document.getElementById('syslog-text').value = '';
            }
            
            // Hide controls since we've cleared the data
            document.getElementById('controls').style.display = 'none';
            
            // Clear the logs container
            document.getElementById('logs-container').innerHTML = '';
            
            // Reset data arrays
            syslogData = [];
            filteredData = [];
        }
        
        // Export to CSV
        function exportToCSV() {
            if (filteredData.length === 0) {
                alert('No data to export.');
                return;
            }
            
            // Define essential fields to include
            const essentialFields = [
                '@timestamp', 'host.name', 'event.category', 'event.type', 'message',
                'process.name', 'process.pid', 'log.source.address', 'log.syslog.facility.name',
                'log.syslog.severity.name', '_id', 'event.original'
            ];
            
            // Create CSV content with essential fields
            let csvContent = essentialFields.join(',') + '\n';
            
            filteredData.forEach(entry => {
                const row = essentialFields.map(field => {
                    const value = entry[field] || '';
                    // Escape quotes and wrap in quotes if needed
                    return `"${value.toString().replace(/"/g, '""')}"`;
                });
                csvContent += row.join(',') + '\n';
            });
            
            // Create download link
            downloadFile(csvContent, 'syslog_export.csv', 'text/csv');
        }
        
        // Export to JSON
        function exportToJSON() {
            if (filteredData.length === 0) {
                alert('No data to export.');
                return;
            }
            
            // Create a simplified version of the data with essential fields
            const simplifiedData = filteredData.map(entry => {
                const simplified = {};
                const essentialFields = [
                    '@timestamp', 'host.name', 'event.category', 'event.type', 'message',
                    'process.name', 'process.pid', 'log.source.address', 'log.syslog.facility.name',
                    'log.syslog.severity.name', '_id', 'event.original'
                ];
                
                essentialFields.forEach(field => {
                    if (entry[field] !== undefined) {
                        simplified[field] = entry[field];
                    }
                });
                
                return simplified;
            });
            
            const jsonContent = JSON.stringify(simplifiedData, null, 2);
            downloadFile(jsonContent, 'syslog_export.json', 'application/json');
        }
        
        // Helper function to download a file
        function downloadFile(content, fileName, contentType) {
            const blob = new Blob([content], { type: contentType });
            const url = URL.createObjectURL(blob);
            
            const link = document.createElement('a');
            link.href = url;
            link.download = fileName;
            document.body.appendChild(link); // Add to DOM for Firefox compatibility
            link.click();
            document.body.removeChild(link); // Clean up
            
            URL.revokeObjectURL(url);
        }
        
        // Load sample data for testing if needed
        function loadSampleData() {
            fetch('sample_syslog.csv')
                .then(response => response.text())
                .then(data => {
                    document.getElementById('syslog-text').value = data;
                    parseTextInput();
                })
                .catch(error => {
                    console.error('Error loading sample data:', error);
                    alert('Failed to load sample data. Please try again or paste your own data.');
                });
        }
    </script>
</body>
</html>
